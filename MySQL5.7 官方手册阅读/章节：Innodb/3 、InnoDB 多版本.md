## InnoDB 多版本

`InnoDB`是一个多版本的存储引擎。它保留有关已更改行的旧版本的信息以支持事务功能，例如并发和回滚。该信息以称为回滚段的数据结构存储在系统表空间或撤消表空间中。请参阅 [第 14.6.3.4 节，“撤消表空间”](https://dev.mysql.com/doc/refman/5.7/en/innodb-undo-tablespaces.html)。`InnoDB` 使用回滚段中的信息来执行事务回滚所需的撤消操作。它还使用这些信息来构建行的早期版本以实现一致读取。请参阅[第 14.7.2.3 节，“一致的非锁定读取”](https://dev.mysql.com/doc/refman/5.7/en/innodb-consistent-read.html)。

在内部，`InnoDB`为存储在数据库中的每一行添加三个字段：

- 一个 6 字节`DB_TRX_ID`字段指示插入或更新行的最后一个事务的事务标识符。此外，删除在内部被视为更新，其中设置了行中的特殊位以将其标记为已删除。
- `DB_ROLL_PTR`称为滚动指针的 7 字节字段。回滚指针指向写入回滚段的撤消日志记录。如果该行被更新，撤消日志记录包含在更新前重建该行内容所需的信息。
- 一个 6 字节的`DB_ROW_ID`字段包含一个行 ID，随着插入新行而单调增加。如果 `InnoDB`自动生成聚集索引，则该索引包含行 ID 值。否则，该 `DB_ROW_ID`列不会出现在任何索引中。

回滚段中的撤消日志分为插入和更新撤消日志。插入撤消日志仅在事务回滚时需要，并且可以在事务提交后立即丢弃。更新撤消日志也用于一致性读取，但只有在没有事务存在且为其`InnoDB`分配快照的情况下才能丢弃它们 ，在一致性读取中可能需要更新撤消日志中的信息来构建较早版本的数据库排。有关撤消日志的其他信息，请参阅[第 14.6.7 节，“撤消日志”](https://dev.mysql.com/doc/refman/5.7/en/innodb-undo-logs.html)。

建议您定期提交事务，包括仅发出一致读取的事务。否则， `InnoDB`无法从更新撤消日志中丢弃数据，并且回滚段可能会变得过大，填满其所在的表空间。有关管理撤消表空间的信息，请参阅[第 14.6.3.4 节，“撤消表空间”](https://dev.mysql.com/doc/refman/5.7/en/innodb-undo-tablespaces.html)。

回滚段中撤消日志记录的物理大小通常小于相应的插入或更新行。您可以使用此信息来计算回滚段所需的空间。

在`InnoDB`多版本控制方案中，当您使用 SQL 语句删除某行时，不会立即从数据库中物理删除该行。`InnoDB`只有在丢弃为删除而写入的更新撤消日志记录时，才物理删除相应的行及其索引记录。这种删除操作称为清除，它非常快，通常与执行删除操作的 SQL 语句花费的时间顺序相同。

如果您在表中以大致相同的速度以相同的速度以小批量插入和删除行，清除线程可能会开始滞后，并且由于所有“死”行，表会变得越来越大 ，从而使所有内容都受磁盘限制并且非常减缓。在这种情况下，通过调整[`innodb_max_purge_lag`](https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_max_purge_lag)系统变量来限制新行操作，并为清除线程分配更多资源 。有关更多信息，请参阅 [第 14.8.10 节，“清除配置”](https://dev.mysql.com/doc/refman/5.7/en/innodb-purge-configuration.html)。

### 多版本和二级索引

`InnoDB`多版本并发控制 (MVCC) 处理二级索引与聚簇索引不同。聚集索引中的记录就地更新，它们隐藏的系统列指向撤消日志条目，可以从中重建记录的早期版本。与聚集索引记录不同，二级索引记录不包含隐藏的系统列，也不会就地更新。

当二级索引列被更新时，旧的二级索引记录被删除标记，新记录被插入，并最终被删除标记记录被清除。当二级索引记录被删除标记或二级索引页被更新的事务更新时，`InnoDB`在聚集索引中查找数据库记录。在聚集索引中，`DB_TRX_ID`检查记录，如果在启动读取事务后修改了记录，则从撤消日志中检索记录的正确版本。

如果二级索引记录被标记为删除或二级索引页被更新的事务更新， 则不使用[覆盖索引](https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_covering_index)技术。不是从索引结构返回值，而是`InnoDB`在聚集索引中查找记录。

但是，如果启用了 [索引条件下推 (ICP)](https://dev.mysql.com/doc/refman/5.7/en/index-condition-pushdown-optimization.html)优化，并且`WHERE`可以仅使用索引中的字段评估部分条件，则 MySQL 服务器仍会将这部分`WHERE`条件下推到存储引擎，在那里使用指数。如果没有找到匹配的记录，则避免聚集索引查找。如果找到匹配的记录，即使是在删除标记的记录中，也会在 `InnoDB`聚集索引中查找该记录。
